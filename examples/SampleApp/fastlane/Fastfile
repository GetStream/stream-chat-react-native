skip_docs

# Common Configuration
github_repo = ENV['GITHUB_REPOSITORY'] || 'GetStream/stream-chat-react-native'
root_path = File.absolute_path('../../../')
sdk_size_ext = 'KB'
@force_check = false
build_output_directory = "./app-build"

# iOS Platform Configuration
bundle_id = 'io.getstream.reactnative.SampleApp'
xcode_project = 'ios/SampleApp.xcodeproj'
xcode_workspace = 'ios/SampleApp.xcworkspace'
output_ipa_name = "reactnativesampleapp.ipa"

# Android Platform Configuration
package_name = 'io.getstream.reactnative.sampleapp'
output_apk_name = "reactnativesampleapp.apk"
apk_path = "#{build_output_directory}/#{output_apk_name}"


before_all do
  if is_ci
    setup_ci
    setup_git_config
  end
end

#######################
###### iOS lanes ######
#######################

platform :ios do
  lane :deploy_to_testflight_qa do |options|
    match_me

    deploy = options.fetch(:deploy, false)

    UI.message("Deploying to Testflight: #{deploy}")

    settings_to_override = {
      BUNDLE_IDENTIFIER: bundle_id,
      PROVISIONING_PROFILE_SPECIFIER: "match AppStore #{bundle_id}"
    }

    gym(
      workspace: xcode_workspace,
      scheme: 'SampleApp',
      export_method: 'app-store',
      export_options: './fastlane/testflight_gym_export_options.plist',
      silent: true,
      clean: true,
      xcargs: settings_to_override,
      include_symbols: true,
      output_directory: build_output_directory
      output_name: File.basename(output_ipa_name, '.ipa')
    )

    if deploy
      increment_version_number(
        version_number: load_json(json_path: './package.json')['version'],
        xcodeproj: xcode_project
      )

      current_build_number = app_store_build_number(
        api_key: appstore_api_key,
        live: false,
        app_identifier: bundle_id
      )

      increment_build_number(
        build_number: current_build_number + 1,
        xcodeproj: xcode_project
      )

      upload_to_testflight(
        groups: ['Testers'],
        changelog: 'Lots of amazing new features to test out!',
        reject_build_waiting_for_review: false,
        ipa: "#{build_output_directory}/#{output_ipa_name}"
      )
    else
        UI.message("Skipping Testflight upload! (deploy: #{deploy})")
    end
  end

  private_lane :appstore_api_key do
    @appstore_api_key ||= app_store_connect_api_key(
      key_id: 'MT3PRT8TB7',
      issuer_id: '69a6de96-0738-47e3-e053-5b8c7c11a4d1',
      key_content: ENV.fetch('APPSTORE_API_KEY', nil),
      in_house: false
    )
  end

  desc "If `readonly: true` (by default), installs all Certs and Profiles necessary for development and ad-hoc.\nIf `readonly: false`, recreates all Profiles necessary for development and ad-hoc, updates them locally and remotely."
  lane :match_me do |options|
    custom_match(
      api_key: appstore_api_key,
      app_identifier: [bundle_id],
      readonly: options[:readonly],
      register_device: options[:register_device]
    )
  end
end

###########################
###### Android lanes ######
###########################

platform :android do
  lane :firebase_build_and_upload do |options|
    deploy = options.fetch(:deploy, false)

    UI.message("Deploying to Firebase: #{deploy}")

    # Clean
    gradle(
        task: "clean",
        project_dir: "./android"
    )

    # Build the AAB
    gradle(
        task: "assemble",
        build_type: "Release",
        project_dir: "./android"
    )

    Dir.chdir('..') do
        sh("mkdir -p #{build_output_directory} && mv -f #{lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]} #{apk_path}")
    end

    if deploy
      # Upload to Firebase App Distribution
      firebase_app_distribution(
          app: ENV.fetch('ANDROID_FIREBASE_APP_ID', nil),
          service_credentials_json_data: ENV.fetch('FIREBASE_CREDENTIALS_JSON', nil),
          android_artifact_path: apk_path,
          android_artifact_type: "APK",
          groups: "stream-testers"
      )
    else
      UI.message("Skipping Firebase upload! (deploy: #{deploy})")
    end
  end
end

##########################
###### Common lanes ######
##########################

lane :file_size do |options|
  File.size(options[:path]) / 1024.0
end

lane :yarn_all do
  Dir.chdir(root_path) { sh('yarn --frozen-lockfile') }
  Dir.chdir("#{root_path}/package") { sh('yarn --frozen-lockfile') }
  Dir.chdir("#{root_path}/package/native-package") { sh('yarn') }
  Dir.chdir("#{root_path}/package/expo-package") { sh('yarn') }
end

lane :frameworks_sizes do
  Dir.chdir(root_path) do
    yarn_all
    sh('yarn build')
    sh('yarn minify-bundle')
    js_bundle_size = file_size(path: 'package/lib/module/bundle.min.js')
    { js_bundle_size: js_bundle_size }
  end
end

lane :show_frameworks_sizes do |options|
  next unless is_check_required(sources: ['package/'], force_check: @force_check)

  sizes = options[:sizes] || frameworks_sizes
  show_sdk_size(branch_sizes: sizes, github_repo: github_repo, size_ext: sdk_size_ext)
  update_img_shields_sdk_sizes(sizes: sizes, open_pr: options[:open_pr]) if options[:update_readme]
end

lane :update_img_shields_sdk_sizes do |options|
  update_sdk_size_in_readme(
    readme_path: '../../README.md',
    open_pr: options[:open_pr] || false,
    pr_title: 'chore: update sdk size',
    sizes: options[:sizes] || frameworks_sizes,
    size_ext: sdk_size_ext
  )
end
